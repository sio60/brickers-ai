name: Deploy to Raspberry Pi

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          timeout: 30m
          script: |
            set -euo pipefail
            cd /home/${{ secrets.USERNAME }}/brickers-ai

            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ“„ Writing .env..."
            # .envê°€ ë””ë ‰í† ë¦¬ë©´ ì‚­ì œ
            if [ -d .env ]; then
              echo "âš ï¸  .env is a directory, removing..."
              rm -rf .env
            fi

            cat > .env <<'EOF'
            # --- ì‹œê°„ëŒ€ ì„¤ì • (í•œêµ­) ---
            TZ=Asia/Seoul

            # --- API Keys ---
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            TRIPO_API_KEY=${{ secrets.TRIPO_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
            NANO_BANANA_MODEL=${{ secrets.NANO_BANANA_MODEL }}

            # --- S3 Upload ---
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            S3_PUBLIC_BASE_URL=${{ secrets.S3_PUBLIC_BASE_URL }}
            S3_PREFIX=uploads/ai-generated

            # --- SQS (2ê°œ Queue ë¶„ë¦¬) ---
            AWS_SQS_REQUEST_QUEUE_URL=${{ secrets.AWS_SQS_REQUEST_QUEUE_URL }}
            AWS_SQS_RESULT_QUEUE_URL=${{ secrets.AWS_SQS_RESULT_QUEUE_URL }}
            AWS_SQS_ENABLED=true
            SQS_POLL_INTERVAL=5
            SQS_MAX_MESSAGES=1
            SQS_VISIBILITY_TIMEOUT=1800
            SQS_WAIT_TIME=10

            # --- Backend URL (Stage ì—…ë°ì´íŠ¸ìš©) ---
            BACKEND_URL=${{ secrets.BACKEND_URL }}

            # --- Co-Scientist Memory (RAG) ---
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            MONGODB_DB=${{ secrets.MONGODB_DB }}
            ATLAS_VECTOR_INDEX_MEMORY=co_scientist_memory_index
            HF_EMBED_MODEL=intfloat/multilingual-e5-small

            # --- Timeouts ---
            KIDS_TOTAL_TIMEOUT_SEC=1800
            TRIPO_WAIT_TIMEOUT_SEC=900
            EOF

            echo "ðŸ”¨ Running build script..."
            chmod +x build.sh
            sudo -E ./build.sh

            echo "ðŸ“‹ Showing container status..."
            sudo docker ps | grep brickers-ai || true

            echo "âœ… Deployment complete!"

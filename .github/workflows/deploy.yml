name: Deploy to Raspberry Pi (Optimized)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: íŒ¨í‚¤ì§€ ë³€ê²½ ì‹œì—ë§Œ ì´ë¯¸ì§€ ë¹Œë“œ
  # - requirements.txt ë³€ê²½ ê°ì§€
  # - ë³€ê²½ëœ ê²½ìš°ì—ë§Œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # ============================================
  check-requirements:
    runs-on: ubuntu-latest
    outputs:
      requirements_changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if requirements.txt changed
        id: check
        run: |
          if git diff --name-only HEAD HEAD~1 | grep -q "requirements.txt"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  build-base-image:
    needs: check-requirements
    if: needs.check-requirements.outputs.requirements_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.optimized
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/brickers-ai:base
          platforms: linux/arm64
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/brickers-ai:base
          cache-to: type=inline

  # ============================================
  # Job 2: ì†ŒìŠ¤ì½”ë“œ ë°°í¬ (ë§¤ë²ˆ ì‹¤í–‰)
  # - ì†ŒìŠ¤ì½”ë“œë§Œ ë³µì‚¬
  # - ì»¨í…Œì´ë„ˆ ìž¬ì‹œìž‘
  # ============================================
  deploy:
    needs: [check-requirements, build-base-image]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy source files to Raspberry Pi
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "route,brick-engine,app.py,config.py,docker-compose.yml"
          target: "/home/${{ secrets.USERNAME }}/brickers-ai"
          overwrite: true

      - name: Execute remote commands via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -euo pipefail
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            cd /home/${{ secrets.USERNAME }}/brickers-ai

            echo "ðŸ”„ Pulling latest code from GitHub..."
            git fetch origin
            git checkout main
            git pull origin main

            echo "ðŸ“„ Writing .env..."
            # .envê°€ ë””ë ‰í† ë¦¬ë©´ ì‚­ì œ
            if [ -d .env ]; then
              echo "âš ï¸  .env is a directory, removing..."
              rm -rf .env
            fi

            cat > .env <<'EOF'
            # --- API Keys ---
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            TRIPO_API_KEY=${{ secrets.TRIPO_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
            NANO_BANANA_MODEL=${{ secrets.NANO_BANANA_MODEL }}

            # --- S3 Upload ---
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            S3_PUBLIC_BASE_URL=${{ secrets.S3_PUBLIC_BASE_URL }}
            S3_PREFIX=uploads/ai-generated

            # --- SQS ---
            AWS_SQS_QUEUE_URL=${{ secrets.AWS_SQS_QUEUE_URL }}
            AWS_SQS_ENABLED=true
            SQS_POLL_INTERVAL=5
            SQS_MAX_MESSAGES=1
            SQS_VISIBILITY_TIMEOUT=1800
            SQS_WAIT_TIME=10

            # --- Backend URL (Stage ì—…ë°ì´íŠ¸ìš©) ---
            BACKEND_URL=${{ secrets.BACKEND_URL }}

            # --- Timeouts ---
            KIDS_TOTAL_TIMEOUT_SEC=1800
            TRIPO_WAIT_TIMEOUT_SEC=900
            EOF

            # ë² ì´ìŠ¤ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ pull (ìµœì´ˆ 1íšŒë§Œ)
            if ! sudo docker images | grep -q "brickers-ai.*base"; then
              echo "ðŸ” Docker Hub login..."
              echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

              echo "ðŸ“¦ Pull base image (first time only)..."
              sudo docker pull ${{ secrets.DOCKER_USERNAME }}/brickers-ai:base
            fi

            # requirements.txt ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì´ë¯¸ì§€ ê°±ì‹ 
            if [ "${{ needs.check-requirements.outputs.requirements_changed }}" = "true" ]; then
              echo "ðŸ“¦ Requirements changed - pulling new base image..."
              echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
              sudo docker pull ${{ secrets.DOCKER_USERNAME }}/brickers-ai:base
            fi

            echo "ðŸ” Restarting container..."
            sudo -E docker compose restart

            echo "âœ… Deployment complete!"
